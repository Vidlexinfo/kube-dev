<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Lab KD106 - Creating Replicated Redis Cluster with Statefulsets - Orchestrating Microservices with Kubernetes</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Lab KD106 - Creating Replicated Redis Cluster with Statefulsets";
    var mkdocs_page_input_path = "13_redis_statefulset.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Orchestrating Microservices with Kubernetes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Docker Pre Reqs</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../operating-containers/">Lab DP101 - Operating Containers</a>
                </li>
                <li class="">
                    
    <a class="" href="../dockerizing-voteapp/">Lab DP102 - Building and Publishing Docker Images</a>
                </li>
                <li class="">
                    
    <a class="" href="../docker-networking/">Lab DP103 - Docker Networking</a>
                </li>
                <li class="">
                    
    <a class="" href="../docker-volumes/">Lab DP104 - Docker Volumes</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kubernetes Pre Reqs</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../quickdive/">Lab KP102 - Kubernetes Quickdive</a>
                </li>
                <li class="">
                    
    <a class="" href="../5-vote-deploying_pods/">Lab KP103 - Kubernetes LaunchPods</a>
                </li>
                <li class="">
                    
    <a class="" href="../replication/">Lab KP104 - Adding HA and Scalability with ReplicaSets</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kubernetes for Devs</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../3_install_kubernetes/">Lab KD101 - Setup Kubernetes Cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../11_deploying_sample_app/">MP001 - Mini Project</a>
                </li>
                <li class="">
                    
    <a class="" href="../7-vote-exposing_app_with_service/">Lab KD102 - Load Balancing and Service Discovery with Services</a>
                </li>
                <li class="">
                    
    <a class="" href="../ingress/">Lab KD103 - Application Routing with Ingress Controllers</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-persistent-volumes/">Lab KD104 - Dynamic Storage Provisioning</a>
                </li>
                <li class="">
                    
    <a class="" href="../9-vote-configmaps_and_secrets/">Lab KD105 - Configurations Management with ConfigMaps</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Lab KD106 - Creating Replicated Redis Cluster with Statefulsets</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#deploying-redis-cluster-with-statefulsets">Deploying Redis Cluster with StatefulSets</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#creating-a-headless-service">Creating a headless service</a></li>
        
            <li><a class="toctree-l4" href="#adding-redis-configurations-with-configmap">Adding Redis configurations with ConfigMap</a></li>
        
            <li><a class="toctree-l4" href="#using-initcontainers-to-configure-redis-replication">Using initContainers to configure redis replication</a></li>
        
            <li><a class="toctree-l4" href="#nano-project-configuring-persistent-volume-claim-per-instance-of-redis">Nano Project: Configuring persistent volume claim per instance of redis</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../helm/">Lab KD107 - Monitoring, Metrics and HELM</a>
                </li>
                <li class="">
                    
    <a class="" href="../network_policies/">Lab KD108 - Access Control with Network Policies</a>
                </li>
                <li class="">
                    
    <a class="" href="../6-vote-kubernetes_deployment/">Lab KD109 - Default Release Strategy with Deployments</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-deployement_strategies/">LAB KD110 - Additional Release Strategies</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Service Mesh</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../istio/setup/">Lab SM101 - Setup Istio Service Mesh</a>
                </li>
                <li class="">
                    
    <a class="" href="../istio/labs/">Lab SM102 - Power of Istio Labs</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Topics</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../configuring_authentication_and_authorization/">Lab K202 - Authentication and Authorization (RBAC)</a>
                </li>
                <li class="">
                    
    <a class="" href="../advanced_pod_scheduling/">Lab K203 - Advanced Pod Scheduling</a>
                </li>
                <li class="">
                    
    <a class="" href="../pods-health-probes/">Lab K204 - Adding health checks with Probes</a>
                </li>
                <li class="">
                    
    <a class="" href="../10_kubernetes_autoscaling/">Lab K206 - Auto Scaling Capacity with HPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../cluster-administration/">Lab K208 - Cluster Administration</a>
                </li>
                <li class="">
                    
    <a class="" href="../12_troubleshooting/">Troubleshooting Tips</a>
                </li>
                <li class="">
                    
    <a class="" href="../logging/">Logging</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Exercises</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../xer-001-pods/">XER001 - Pods</a>
                </li>
                <li class="">
                    
    <a class="" href="../xer-002-rs/">XER002 - ReplicaSets</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Web Quests</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../wq001-cni/">KWQ001 - CNI Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq002-security/">KWQ001 - Kubernetes Security Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq003-ingress/">KWQ003 - Ingress Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq004-monitoring/">KWQ004 - Monitoring Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq005-controllers/">KWQ005 - Controllers Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq006-persistentvolume/">KWQ006 - Persistent Data Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq007-maintenance/">KWQ007 - Cluster Maintenance Web Quest</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">References</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../rbac-resource-group-mapping/">RBAC apiGroups to Resource Mapping</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Orchestrating Microservices with Kubernetes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Kubernetes for Devs &raquo;</li>
        
      
    
    <li>Lab KD106 - Creating Replicated Redis Cluster with Statefulsets</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="deploying-redis-cluster-with-statefulsets">Deploying Redis Cluster with StatefulSets</h1>
<p>What will you learn  </p>
<ul>
<li>Statefulsets  </li>
<li>initContainers</li>
</ul>
<h2 id="creating-a-headless-service">Creating a headless service</h2>
<p>We will use Redis as Statefulsets for our instavote application stack.
It is similar to Deployment, but Statefulsets requires a <code>Service Name</code>.</p>
<p>Lets being by cleaning up the existing redis installation</p>
<pre><code>kubectl delete svc redis
kubectl delete deploy redis
</code></pre>

<p>So we will create a <strong>headless</strong> service for redis first. A headless service is the one which will be created with no ClusterIP of its own, but will return the actual IP address of its endpoints (e.g. pods), which we would create later in this case.</p>
<p><code>file: dev/redis-sts/redis-svc.yml</code></p>
<pre><code>kind: Service
metadata:
  name: redis
  labels:
    app: redis
spec:
  type: ClusterIP
  ports:
  - name: redis
    port: 6379
    targetPort: redis
  clusterIP: None
  selector:
    app: redis
    role: master
</code></pre>

<p>Observe</p>
<ul>
<li>clusterIP value is set to None</li>
<li>selector has been updated to send traffic only to the master</li>
</ul>
<p>now apply this and validate</p>
<pre><code>kubectl apply -f redis-svc.yml

kubectl get svc
kubectl describe  svc redis
</code></pre>

<h2 id="adding-redis-configurations-with-configmap">Adding Redis configurations with ConfigMap</h2>
<p>Lets now add the redis configuration with configmap.</p>
<p>Redis ConfigMap has two keys
  * master.conf - to provide  Redis master configs
  * slave.conf - to provide  Redis slave configs</p>
<p><code>file: redis-cm.yml</code></p>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: redis
data:
  master.conf: |
    bind 0.0.0.0
    protected-mode yes
    port 6379
    tcp-backlog 511
    timeout 0
    tcp-keepalive 300
    daemonize no
    supervised no
    pidfile /var/run/redis_6379.pid
    loglevel notice
    logfile &quot;&quot;
  slave.conf: |
    slaveof redis-0.redis 6379
</code></pre>

<p>apply and validate</p>
<pre><code>kubectl apply -f redis-cm.yml

kubectl get cm
kubectl describe cm redis
</code></pre>

<h2 id="using-initcontainers-to-configure-redis-replication">Using initContainers to configure redis replication</h2>
<p>We have to deploy redis master/slave set up from one statefulset cluster. This requires two different redis cofigurations , which needs to be described in one Pod template. This complexity can be resolved by using init containers. These init containers copy the appropriate redis configuration by analysing the hostname of the pod. If the Pod's (host)name has <code>0</code> as <strong>Ordinal number</strong>, then it is choosen as the master and master.conf is copied to /etc/ directory. Every other  pod will be configured as a replica with  slave.conf as configuration.</p>
<p><code>file: redis-sts.yml</code></p>
<pre><code>[...]
      initContainers:
      - name: init-redis
        image: redis:4.0.9
        command:
        - bash
        - &quot;-c&quot;
        - |
          set -ex
          # Generate mysql server-id from pod ordinal index.
          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
          ordinal=${BASH_REMATCH[1]}
          # Copy appropriate conf.d files from config-map to emptyDir.
          if [[ $ordinal -eq 0 ]]; then
            cp /mnt/config-map/master.conf /etc/redis.conf
          else
            cp /mnt/config-map/slave.conf /etc/redis.conf
          fi
        volumeMounts:
        - name: conf
          mountPath: /etc
          subPath: redis.conf
        - name: config-map
          mountPath: /mnt/config-map
</code></pre>

<h3 id="deploying-redis-master-slaves-with-statefulsets">Deploying Redis Master Slaves with Statefulsets</h3>
<p>These redis containers are started after initContainers are succefully run and exit. One thing to note here, these containers mount the same volume, <code>conf</code>, from the initContainers which has the proper Redis configuration.</p>
<p><code>file: redis-sts.yaml</code></p>
<pre><code>[...]
      containers:
      - name: redis
        image: redis:4.0.9
        command: [&quot;redis-server&quot;]
        args: [&quot;/etc/redis.conf&quot;]
        env:
        - name: ALLOW_EMPTY_PASSWORD
          value: &quot;yes&quot;
        ports:
        - name: redis
          containerPort: 6379
        volumeMounts:
        - name: redis-data
          mountPath: /data
        - name: conf
          mountPath: /etc/
          subPath: redis.conf
</code></pre>

<p>To apply</p>
<pre><code>kubectl apply -f redis-sts.yml
</code></pre>

<p>Validate the MASTER-SLAVE configuration</p>
<pre><code>kubectl exec redis-0 redis-cli ROLE

kubectl exec redis-1 redis-cli ROLE
</code></pre>

<p>redis-0 should have been  configured as master, redis-1 as slave.  You should also see that redis-1 is been configured as the slave of redis-0.redis as follows,</p>
<pre><code>kubectl exec redis-1 redis-cli ROLE
slave
redis-0.redis
6379
connected
28
</code></pre>

<p>This validated the redis master slave configuration.</p>
<h2 id="nano-project-configuring-persistent-volume-claim-per-instance-of-redis">Nano Project: Configuring persistent volume claim per instance of redis</h2>
<p>Similar to databases, each redis instance needs its own data store, which should also be persistent. Current code that you have applied uses emptyDir as the volume type. This is a problem as emptyDir gets deleted when the pod is deleted, and is not persistent.    </p>
<p>Your task is to update the YAML file for the statefulset  with the following changes,</p>
<ul>
<li>use volumeClaimTemplate instead of volumes for volume <strong>redis-data</strong>. This will ensure a persistentVolumeClaim per replica/pod. All other volumes remain unchanged.</li>
<li>Provide the storageClass as NFS, a provisioner for which is already been configured</li>
<li>Size of the volume could be 200Mi as its just a key value store used by the instavote app to store the votes.</li>
<li>accessModes should be ReadWriteOnce as the volumes for redis should not be shared between multiple instances.</li>
</ul>
<p>Update the statefulSet, apply and validate that persistentVolumeClaim and persistentVolume are created for each instance/pod of redis application.</p>
<h5 id="reading-list">Reading List</h5>
<ul>
<li><a href="https://redis.io/topics/replication">Redis Replication</a></li>
<li><a href="https://kubernetes.io/docs/tasks/run-application/run-replicated-stateful-application/">Run Replicated Statefulsets Applications</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/">Init Containers</a></li>
</ul>
<p><strong>Search Keywords</strong></p>
<ul>
<li>init containers</li>
<li>kubernetes statefulsets</li>
<li>redis replication</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../helm/" class="btn btn-neutral float-right" title="Lab KD107 - Monitoring, Metrics and HELM">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../9-vote-configmaps_and_secrets/" class="btn btn-neutral" title="Lab KD105 - Configurations Management with ConfigMaps"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../9-vote-configmaps_and_secrets/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../helm/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
