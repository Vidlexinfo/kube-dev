<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Lab KD101 - Setup Kubernetes Cluster - Orchestrating Microservices with Kubernetes</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Lab KD101 - Setup Kubernetes Cluster";
    var mkdocs_page_input_path = "3_install_kubernetes.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Orchestrating Microservices with Kubernetes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Docker Pre Reqs</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../operating-containers/">Lab DP101 - Operating Containers</a>
                </li>
                <li class="">
                    
    <a class="" href="../dockerizing-voteapp/">Lab DP102 - Building and Publishing Docker Images</a>
                </li>
                <li class="">
                    
    <a class="" href="../docker-networking/">Lab DP103 - Docker Networking</a>
                </li>
                <li class="">
                    
    <a class="" href="../docker-volumes/">Lab DP104 - Docker Volumes</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kubernetes Pre Reqs</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../quickdive/">Lab KP102 - Kubernetes Quickdive</a>
                </li>
                <li class="">
                    
    <a class="" href="../5-vote-deploying_pods/">Lab KP103 - Kubernetes LaunchPods</a>
                </li>
                <li class="">
                    
    <a class="" href="../replication/">Lab KP104 - Adding HA and Scalability with ReplicaSets</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kubernetes for Devs</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">Lab KD101 - Setup Kubernetes Cluster</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#lab-setting-up-kubernetes-cluster-with-kubeadm">LAB - Setting up Kubernetes Cluster with Kubeadm</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#compatibility">Compatibility</a></li>
        
            <li><a class="toctree-l4" href="#initializing-master">Initializing Master</a></li>
        
            <li><a class="toctree-l4" href="#setup-networking-with-calico-plugin">Setup Networking with Calico Plugin</a></li>
        
            <li><a class="toctree-l4" href="#validating-the-setup">Validating the Setup</a></li>
        
            <li><a class="toctree-l4" href="#enable-kubernetes-dashboard">Enable Kubernetes Dashboard</a></li>
        
            <li><a class="toctree-l4" href="#set-up-visualiser">Set up Visualiser</a></li>
        
            <li><a class="toctree-l4" href="#download-the-supporting-code">Download the supporting code</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../11_deploying_sample_app/">MP001 - Mini Project</a>
                </li>
                <li class="">
                    
    <a class="" href="../7-vote-exposing_app_with_service/">Lab KD102 - Load Balancing and Service Discovery with Services</a>
                </li>
                <li class="">
                    
    <a class="" href="../ingress/">Lab KD103 - Application Routing with Ingress Controllers</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-persistent-volumes/">Lab KD104 - Dynamic Storage Provisioning</a>
                </li>
                <li class="">
                    
    <a class="" href="../13_redis_statefulset/">Lab KD105 - Creating Replicated Redis Cluster with Statefulsets</a>
                </li>
                <li class="">
                    
    <a class="" href="../9-vote-configmaps_and_secrets/">Lab KD106 - Configurations Management with ConfigMaps</a>
                </li>
                <li class="">
                    
    <a class="" href="../helm/">Lab KD107 - Monitoring, Metrics and HELM</a>
                </li>
                <li class="">
                    
    <a class="" href="../network_policies/">Lab KD108 - Access Control with Network Policies</a>
                </li>
                <li class="">
                    
    <a class="" href="../6-vote-kubernetes_deployment/">Lab KD109 - Default Release Strategy with Deployments</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-deployement_strategies/">LAB KD110 - Additional Release Strategies</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Topics</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../configuring_authentication_and_authorization/">Lab K202 - Authentication and Authorization (RBAC)</a>
                </li>
                <li class="">
                    
    <a class="" href="../advanced_pod_scheduling/">Lab K203 - Advanced Pod Scheduling</a>
                </li>
                <li class="">
                    
    <a class="" href="../pods-health-probes/">Lab K204 - Adding health checks with Probes</a>
                </li>
                <li class="">
                    
    <a class="" href="../10_kubernetes_autoscaling/">Lab K206 - Auto Scaling Capacity with HPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../cluster-administration/">Lab K208 - Cluster Administration</a>
                </li>
                <li class="">
                    
    <a class="" href="../12_troubleshooting/">Troubleshooting Tips</a>
                </li>
                <li class="">
                    
    <a class="" href="../logging/">Logging</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Exercises</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../xer-001-pods/">XER001 - Pods</a>
                </li>
                <li class="">
                    
    <a class="" href="../xer-002-rs/">XER002 - ReplicaSets</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Web Quests</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../wq001-cni/">KWQ001 - CNI Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq002-security/">KWQ001 - Kubernetes Security Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq003-ingress/">KWQ003 - Ingress Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq004-monitoring/">KWQ004 - Monitoring Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq005-controllers/">KWQ005 - Controllers Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq006-persistentvolume/">KWQ006 - Persistent Data Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq007-maintenance/">KWQ007 - Cluster Maintenance Web Quest</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">References</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../rbac-resource-group-mapping/">RBAC apiGroups to Resource Mapping</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Orchestrating Microservices with Kubernetes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Kubernetes for Devs &raquo;</li>
        
      
    
    <li>Lab KD101 - Setup Kubernetes Cluster</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="lab-setting-up-kubernetes-cluster-with-kubeadm">LAB - Setting up Kubernetes Cluster with Kubeadm</h1>
<p>This documents describes how to setup kubernetes from scratch on your own nodes, without using a managed service. This setup uses <strong>kubeadm</strong> to install and configure kubernetes cluster.</p>
<h2 id="compatibility">Compatibility</h2>
<p>Kubernetes is an open-source system for automating deployment, scaling, and management of containerized applications.</p>
<p>The below steps are applicable for the below mentioned OS</p>
<table>
<thead>
<tr>
<th>OS</th>
<th>Version</th>
<th>Codename</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Ubuntu</strong></td>
<td><strong>16.04 / 18.04</strong></td>
<td><strong>Xenial</strong></td>
</tr>
</tbody>
</table>
<h2 id="initializing-master">Initializing Master</h2>
<p>This tutorial assumes <strong>kube-01</strong>  as the master and used kubeadm as a tool to install and setup the cluster. This section also assumes that you are using vagrant based setup provided along with this tutorial. If not, please update the IP address of the master accordingly.</p>
<p>To initialize master, run this on kube-01 (1st node)</p>
<p><code>replace 192.168.56.101 with the actual IP of your node</code></p>
<pre><code>kubeadm init --apiserver-advertise-address 192.168.56.101 --pod-network-cidr=192.168.0.0/16

</code></pre>

<h3 id="initialization-of-the-nodes-previously-minions">Initialization of the Nodes (Previously Minions)</h3>
<p>After master being initialized, it should display the command which could be used on all worker/nodes to join the k8s cluster.</p>
<p>e.g.</p>
<pre><code>kubeadm join --token c04797.8db60f6b2c0dd078 192.168.12.10:6443 --discovery-token-ca-cert-hash sha256:88ebb5d5f7fdfcbbc3cde98690b1dea9d0f96de4a7e6bf69198172debca74cd0
</code></pre>

<p><code>dont copy above command as is, this is just a sample, use actual</code></p>
<p>Copy and paste it on all node.</p>
<h3 id="setup-the-admin-client-kubectl">Setup the admin client - Kubectl</h3>
<p><code>on Master Node</code></p>
<pre><code>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>

<p>Validate</p>
<pre><code>kubectl get nodes
</code></pre>

<p>You could also put the above command on a watch to observe the nodes getting ready.</p>
<pre><code>watch kubectl get nodes
</code></pre>

<h2 id="setup-networking-with-calico-plugin">Setup Networking with Calico Plugin</h2>
<p>Installing overlay network is necessary for the pods to communicate with each other across the hosts. It is necessary to do this before you try to deploy any applications to your cluster.</p>
<p>There are various overlay networking drivers available for kubernetes. We are going to use <strong>Calico</strong>.</p>
<pre><code>
kubectl apply -f https://docs.projectcalico.org/v3.11/manifests/calico.yaml


</code></pre>

<h2 id="validating-the-setup">Validating the Setup</h2>
<p>You could validate the status of this cluster, health of pods and whether all the components are up or not by using a few or all of the following commands.</p>
<p>To check if nodes are ready</p>
<pre><code>kubectl get nodes
kubectl get cs

</code></pre>

<p>[ Expected output ]</p>
<pre><code>root@kube-01:~# kubectl get nodes
NAME      STATUS    ROLES     AGE       VERSION
kube-01   Ready     master    9m        v1.8.2
kube-02   Ready     &lt;none&gt;    4m        v1.8.2
kube-03   Ready     &lt;none&gt;    4m        v1.8.2
</code></pre>

<p>Additional Status Commands</p>
<pre><code>kubectl version

kubectl cluster-info

kubectl get pods -n kube-system

kubectl get events

</code></pre>

<p>It will take a few minutes to have the cluster up and running with all the services.</p>
<h2 id="enable-kubernetes-dashboard">Enable Kubernetes Dashboard</h2>
<p>After the Pod networks is installled, We can install another add-on service which is Kubernetes Dashboard.</p>
<p>Installing Dashboard:</p>
<pre><code>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta8/aio/deploy/recommended.yaml

kubectl apply -f https://gist.githubusercontent.com/initcron/a05b9609b506c6ffc6189bcf690d2304/raw/914169df84ca54c292ee0d8220339469d3bba585/dashboard-rbac.yaml



</code></pre>

<p>You could access kubernetes Dashboard only if you have setup kubectl on your local machine.  If thats the case, setup a proxy to api server using</p>
<pre><code>kubectl proxy
</code></pre>

<p>And proceed to access the dashboard by loading the following URL in your browser</p>
<p>http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/login</p>
<p>Then choose <strong>Token</strong> as authentication type.  </p>
<p><img alt="auth token" src="../images/token.png" /></p>
<p>To get the token, run the following command,</p>
<pre><code>kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk '{print $1}')
</code></pre>

<p>[Sample Output]</p>
<pre><code>Name:         admin-user-token-4slg6
Namespace:    kubernetes-dashboard
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name: admin-user
              kubernetes.io/service-account.uid: c416ba59-86eb-440d-a85b-48000fb1e20b

Type:  kubernetes.io/service-account-token

Data
====
namespace:  20 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IjdkWjJmaHR5UzBvd2R3c1JubFRMSHl3WTY4OXV2VUQ5ZUZHV2JpazZEMmcifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTRzbGc2Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJjNDE2YmE1OS04NmViLTQ0MGQtYTg1Yi00ODAwMGZiMWUyMGIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.BkGm69kZ5xmc_hF5bqOT7Dr4IWmXjUQxnjBYujJzMYz2iiI7wLIaZ4Kh-Li77C3KViKJ3WMY3R6gqarGo8SIRIdvI2fMuW5eIVcVs_q_lL3M0mLnUQDtkv-BqW80JRGAzzE2CXyFrtZOy7fr4nWh_9GAT78uQoIamkwiGgzc2tb8mGXBLxMWIJrsI_xXJ5231IZQX0aCarQhs2NNa5yV3hNGvxaEzG8Pxh0cjd4Ve8bKxNwkhsaMD5set5thd9DNx6kMNQIhc1978pu2Gq2dmuRW7J6XrC3KOx2wOBX4oeYrzCsTr1LS1fVNNSSI7BIepv5p5xhKrvsCPzKKevgPGg
ca.crt:     1025 bytes
</code></pre>

<p>Copy over the token and complete authentication process to access  the dashboard.</p>
<p>The Dashboard Looks like:</p>
<p><img alt="Kubernetes Dashboard.\label{fig:captioned_image}" src="../images/dashboard-2020.png" /></p>
<h2 id="set-up-visualiser">Set up Visualiser</h2>
<p>Fork the repository and deploy the visualizer on kubernetes</p>
<pre><code>git clone  https://github.com/schoolofdevops/kube-ops-view
cd kube-ops-view/deploy/
kubectl apply -f auth.yaml -f deployment.yaml -f ingress.yaml -f service.yaml
cd -
</code></pre>

<p>Visualiser will run on  <strong>32000</strong> port. You could access it using a URL such as below and  add /#scale=2.0 or similar option where 2.0 = 200% the scale.</p>
<p><code>replace &lt;NODE_IP&gt; with actual IP of one of your nodes</code></p>
<pre><code>http://&lt;NODE_IP&gt;:32000/#scale=2.0
</code></pre>

<p><img alt="kube-visualizer" src="../images/kube-ops-view.png" /></p>
<p>Kubernetes visualiser is a third party application which provides a operational view of your kubernetes cluster. Its very useful tool for learning kubernetes as it demonstrates the state of the cluster as well as state of the pods as you make changes. You could read further about it <a href="https://kubernetes-operational-view.readthedocs.io/en/latest/">at this link</a>.  </p>
<h2 id="download-the-supporting-code">Download the supporting code</h2>
<p>Before we proceed further, please checkout the code from the following git repo. This would offer the supporting code for the exercises that follow.</p>
<p><code>run this on the host where you have configured kubectl</code></p>
<pre><code>git clone https://github.com/devopsfoo/k8s-code.git
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../11_deploying_sample_app/" class="btn btn-neutral float-right" title="MP001 - Mini Project">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../replication/" class="btn btn-neutral" title="Lab KP104 - Adding HA and Scalability with ReplicaSets"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../replication/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../11_deploying_sample_app/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
