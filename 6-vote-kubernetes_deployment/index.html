<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Lab K106 - Defining Release Strategy with Deployments - Orchestrating Microservices with Kubernetes</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Lab K106 - Defining Release Strategy with Deployments";
    var mkdocs_page_input_path = "6-vote-kubernetes_deployment.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Orchestrating Microservices with Kubernetes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Just Enough Docker</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../operating-containers/">Lab D101 - Operating Containers</a>
                </li>
                <li class="">
                    
    <a class="" href="../dockerizing-voteapp/">Lab D102 - Building and Publishing Docker Images</a>
                </li>
                <li class="">
                    
    <a class="" href="../docker-networking/">Lab D103 - Docker Networking</a>
                </li>
                <li class="">
                    
    <a class="" href="../docker-volumes/">Lab D104 - Docker Volumes</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kubernetes Fundamentals</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../3_install_kubernetes/">Lab K101 - Setup Kubernetes Cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../quickdive/">Lab K102 - Kubernetes Quickdive</a>
                </li>
                <li class="">
                    
    <a class="" href="../5-vote-deploying_pods/">Lab K103 - Kubernetes LaunchPods</a>
                </li>
                <li class="">
                    
    <a class="" href="../replication/">Lab K104 - Adding HA and Scalability with ReplicaSets</a>
                </li>
                <li class="">
                    
    <a class="" href="../7-vote-exposing_app_with_service/">Lab K105 - Load Balancing and Service Discovery with Services</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Lab K106 - Defining Release Strategy with Deployments</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#lab-k106-defining-release-strategy-with-deployment">LAB K106 - Defining Release Strategy with  Deployment</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#rolling-out-a-new-version">Rolling out a new version</a></li>
        
            <li><a class="toctree-l4" href="#breaking-a-rollout">Breaking a Rollout</a></li>
        
            <li><a class="toctree-l4" href="#undo-and-rollback">Undo and Rollback</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../11_deploying_sample_app/">MP001 - Mini Project</a>
                </li>
                <li class="">
                    
    <a class="" href="../9-vote-configmaps_and_secrets/">Lab K107 - Configurations Management with ConfigMaps</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-persistent-volumes/">Lab K108 - Peristent Volumes</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Advanced Administration</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../ingress/">Lab K201 - Application Routing with Ingress Controllers</a>
                </li>
                <li class="">
                    
    <a class="" href="../configuring_authentication_and_authorization/">Lab K202 - Authentication and Authorization (RBAC)</a>
                </li>
                <li class="">
                    
    <a class="" href="../advanced_pod_scheduling/">Lab K203 - Advanced Pod Scheduling</a>
                </li>
                <li class="">
                    
    <a class="" href="../pods-health-probes/">Lab K204 - Adding health checks with Probes</a>
                </li>
                <li class="">
                    
    <a class="" href="../helm/">Lab K205 - Monitoring setup with HELM</a>
                </li>
                <li class="">
                    
    <a class="" href="../10_kubernetes_autoscaling/">Lab K206 - Auto Scaling Capacity with HPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../network_policies/">Lab K207 - Access Control with Network Policies</a>
                </li>
                <li class="">
                    
    <a class="" href="../cluster-administration/">Lab K208 - Cluster Administration</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Topics</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../13_redis_statefulset/">Creating Replicated Redis Cluster with Statefulsets</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-deployement_strategies/">Building Deployment Strategies</a>
                </li>
                <li class="">
                    
    <a class="" href="../12_troubleshooting/">Troubleshooting Tips</a>
                </li>
                <li class="">
                    
    <a class="" href="../logging/">Logging</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Exercises</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../xer-001-pods/">XER001 - Pods</a>
                </li>
                <li class="">
                    
    <a class="" href="../xer-002-rs/">XER002 - ReplicaSets</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Web Quests</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../wq001-cni/">KWQ001 - CNI Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq002-security/">KWQ001 - Kubernetes Security Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq003-ingress/">KWQ003 - Ingress Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq004-monitoring/">KWQ004 - Monitoring Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq005-controllers/">KWQ005 - Controllers Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq006-persistentvolume/">KWQ006 - Persistent Data Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq007-maintenance/">KWQ007 - Cluster Maintenance Web Quest</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">References</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../rbac-resource-group-mapping/">RBAC apiGroups to Resource Mapping</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Orchestrating Microservices with Kubernetes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Kubernetes Fundamentals &raquo;</li>
        
      
    
    <li>Lab K106 - Defining Release Strategy with Deployments</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="lab-k106-defining-release-strategy-with-deployment">LAB K106 - Defining Release Strategy with  Deployment</h1>
<p>A Deployment is a higher level abstraction which sits on top of replica sets and allows you to manage the way applications are deployed, rolled back at a controlled rate.</p>
<p>Deployment provides three features,</p>
<ul>
<li>Availability: Maintain the number of replicas for a type of service/app. Schedule/delete pods to meet the desired count.</li>
<li>Scalability: Updating the replica count, allows you to scale in and out, and its the responsibility of the deployment to provide with that scalability. You could scale manually or use horizontalPodAutoscaler to do it automatically.  </li>
<li>Update Strategy: Define a release strategy and update the pods accordingly.</li>
</ul>
<pre><code>/k8s-code/projects/instavote/dev/
cp vote-rs.yaml vote-deploy.yaml
</code></pre>

<p>Deployment spec (deployment.spec) contains everything that replica set has + strategy. Lets add it as follows,</p>
<p><code>file: vote-deploy.yaml</code></p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: vote
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2
      maxUnavailable: 1
  revisionHistoryLimit: 4
  replicas: 12
  minReadySeconds: 20
  selector:
    matchLabels:
      role: vote
    matchExpressions:
      - {key: version, operator: In, values: [v1, v2, v3, v4, v5]}
  template:
    metadata:
      name: vote
      labels:
        app: python
        role: vote
        version: v1
    spec:
      containers:
        - name: app
          image: schoolofdevops/vote:v1
          resources:
            requests:
              memory: &quot;64Mi&quot;
              cpu: &quot;50m&quot;
            limits:
              memory: &quot;128Mi&quot;
              cpu: &quot;250m&quot;
</code></pre>

<p>In a additional terminal where you have kubectl client setup, launch the monitoring console by running the following command. Ensure you have --show-labels options set.</p>
<pre><code>watch -n 1 kubectl get all --show-labels
</code></pre>

<p>Lets  create the Deployment. Do monitor the labels of the pod while applying this.</p>
<pre><code>kubectl apply -f vote-deploy.yaml
</code></pre>

<p>Observe the chances to pod labels, specifically the <strong>pod-template-hash</strong>.</p>
<p>Now that the deployment is created. To validate,</p>
<pre><code>kubectl get deployment
kubectl get rs --show-labels
kubectl get deploy,pods,rs
kubectl rollout status deployment/vote
kubectl get pods --show-labels
</code></pre>

<h2 id="rolling-out-a-new-version">Rolling out a new version</h2>
<p>Now, update the deployment spec to use a new version of the image.</p>
<p>file: vote-deploy.yaml</p>
<pre><code>
...
template:
  metadata:
    labels:
      version: v2   
  spec:
    containers:
      - name: app
        image: schoolofdevops/vote:v2

</code></pre>

<p>and trigger a rollout by applying it</p>
<pre><code>kubectl apply -f vote-deploy.yaml

kubectl rollout status deployment/vote
</code></pre>

<p>Observe the following</p>
<ul>
<li>rollout status using the command above</li>
<li>following fields for vote deployment on monitoring screen<ul>
<li>READY count (will reflect surged replicas e.g. 14/12)</li>
<li>AVAILABLE count ( will never fall below REPLICAS - maxUnavilable)</li>
<li>UP-TO-DATE field will reflect replicas with latest version defined in deployment spec</li>
</ul>
</li>
<li>observe that a new replicaset is created for every rollout.  </li>
<li>Continuously refresh the vote application in the browser to see new version if being rolled out without a downtime.  </li>
</ul>
<p>Try updating the version of the image from v2 to v3,v4,v5. Repeat a few times to observe how it rolls out a new version.  </p>
<h2 id="breaking-a-rollout">Breaking a Rollout</h2>
<p>Introduce an error by using an image which does not exist.</p>
<p>file: vote-deploy.yaml</p>
<pre><code>spec:
  containers:
    - name: app
      image: schoolofdevops/vote:rgjerdf

</code></pre>

<p>apply</p>
<pre><code>kubectl apply -f vote-deploy.yaml

kubectl rollout status
</code></pre>

<p>Observe how  deployment handles the failure in the rolls out.</p>
<h2 id="undo-and-rollback">Undo and Rollback</h2>
<p>To observe  the rollout history use the following commands.</p>
<pre><code>
kubectl rollout history deploy/vote

kubectl rollout history deploy/vote --revision=xx
</code></pre>

<p>where replace xx with revisions</p>
<p>Find out the previous revision with sane configs.</p>
<p>To undo to a sane version (for example revision 2)</p>
<pre><code>kubectl rollout undo deploy/vote --to-revision=2
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../11_deploying_sample_app/" class="btn btn-neutral float-right" title="MP001 - Mini Project">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../7-vote-exposing_app_with_service/" class="btn btn-neutral" title="Lab K105 - Load Balancing and Service Discovery with Services"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../7-vote-exposing_app_with_service/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../11_deploying_sample_app/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
