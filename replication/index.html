<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Lab KP104 - Adding HA and Scalability with ReplicaSets - Orchestrating Microservices with Kubernetes</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Lab KP104 - Adding HA and Scalability with ReplicaSets";
    var mkdocs_page_input_path = "replication.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Orchestrating Microservices with Kubernetes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Docker Pre Reqs</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../operating-containers/">Lab DP101 - Operating Containers</a>
                </li>
                <li class="">
                    
    <a class="" href="../dockerizing-voteapp/">Lab DP102 - Building and Publishing Docker Images</a>
                </li>
                <li class="">
                    
    <a class="" href="../docker-networking/">Lab DP103 - Docker Networking</a>
                </li>
                <li class="">
                    
    <a class="" href="../docker-volumes/">Lab DP104 - Docker Volumes</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kubernetes Pre Reqs</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../quickdive/">Lab KP102 - Kubernetes Quickdive</a>
                </li>
                <li class="">
                    
    <a class="" href="../5-vote-deploying_pods/">Lab KP103 - Kubernetes LaunchPods</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Lab KP104 - Adding HA and Scalability with ReplicaSets</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#lab-k104-adding-ha-and-scalability-with-replicasets">Lab K104 - Adding HA and Scalability with ReplicaSets</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#creating-a-namespace-and-switching-to-it">Creating a Namespace and switching to it</a></li>
        
            <li><a class="toctree-l4" href="#creating-a-namespace">Creating a namespace</a></li>
        
            <li><a class="toctree-l4" href="#adding-replicaset-configurations">Adding ReplicaSet Configurations</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kubernetes for Devs</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../3_install_kubernetes/">Lab KD101 - Setup Kubernetes Cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../11_deploying_sample_app/">MP001 - Mini Project</a>
                </li>
                <li class="">
                    
    <a class="" href="../7-vote-exposing_app_with_service/">Lab KD102 - Load Balancing and Service Discovery with Services</a>
                </li>
                <li class="">
                    
    <a class="" href="../ingress/">Lab KD103 - Application Routing with Ingress Controllers</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-persistent-volumes/">Lab KD104 - Dynamic Storage Provisioning</a>
                </li>
                <li class="">
                    
    <a class="" href="../13_redis_statefulset/">Lab KD105 - Creating Replicated Redis Cluster with Statefulsets</a>
                </li>
                <li class="">
                    
    <a class="" href="../9-vote-configmaps_and_secrets/">Lab KD106 - Configurations Management with ConfigMaps</a>
                </li>
                <li class="">
                    
    <a class="" href="../helm/">Lab KD107 - Monitoring, Metrics and HELM</a>
                </li>
                <li class="">
                    
    <a class="" href="../network_policies/">Lab KD108 - Access Control with Network Policies</a>
                </li>
                <li class="">
                    
    <a class="" href="../6-vote-kubernetes_deployment/">Lab KD109 - Default Release Strategy with Deployments</a>
                </li>
                <li class="">
                    
    <a class="" href="../vote-deployement_strategies/">LAB KD110 - Additional Release Strategies</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Service Mesh</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../istio/setup/">Lab SM101 - Setup Istio Service Mesh</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Topics</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../configuring_authentication_and_authorization/">Lab K202 - Authentication and Authorization (RBAC)</a>
                </li>
                <li class="">
                    
    <a class="" href="../advanced_pod_scheduling/">Lab K203 - Advanced Pod Scheduling</a>
                </li>
                <li class="">
                    
    <a class="" href="../pods-health-probes/">Lab K204 - Adding health checks with Probes</a>
                </li>
                <li class="">
                    
    <a class="" href="../10_kubernetes_autoscaling/">Lab K206 - Auto Scaling Capacity with HPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../cluster-administration/">Lab K208 - Cluster Administration</a>
                </li>
                <li class="">
                    
    <a class="" href="../12_troubleshooting/">Troubleshooting Tips</a>
                </li>
                <li class="">
                    
    <a class="" href="../logging/">Logging</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Exercises</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../xer-001-pods/">XER001 - Pods</a>
                </li>
                <li class="">
                    
    <a class="" href="../xer-002-rs/">XER002 - ReplicaSets</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Web Quests</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../wq001-cni/">KWQ001 - CNI Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq002-security/">KWQ001 - Kubernetes Security Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq003-ingress/">KWQ003 - Ingress Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq004-monitoring/">KWQ004 - Monitoring Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq005-controllers/">KWQ005 - Controllers Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq006-persistentvolume/">KWQ006 - Persistent Data Web Quest</a>
                </li>
                <li class="">
                    
    <a class="" href="../wq007-maintenance/">KWQ007 - Cluster Maintenance Web Quest</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">References</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../rbac-resource-group-mapping/">RBAC apiGroups to Resource Mapping</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Orchestrating Microservices with Kubernetes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Kubernetes Pre Reqs &raquo;</li>
        
      
    
    <li>Lab KP104 - Adding HA and Scalability with ReplicaSets</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="lab-k104-adding-ha-and-scalability-with-replicasets">Lab K104 - Adding HA and Scalability with ReplicaSets</h1>
<p>If you are not running a monitoring screen, start it in a new terminal with the following command.</p>
<pre><code>watch -n 1 kubectl get  pod,deploy,rs,svc
</code></pre>

<h3 id="creating-a-namespace-and-switching-to-it">Creating a Namespace and switching to it</h3>
<p>Check current config</p>
<pre><code>
kubectl config view
</code></pre>

<p>You could also examine the current configs in file <strong>cat ~/.kube/config</strong></p>
<h2 id="creating-a-namespace">Creating a namespace</h2>
<p>Namespaces offers separation of resources running on the same physical infrastructure into virtual clusters. It is typically useful in mid to large scale environments with multiple projects, teams and need separate scopes. It could also be useful to map to your workflow stages e.g. dev, stage, prod.   </p>
<p>Lets create a namespace called <strong>instavote</strong>  </p>
<pre><code>kubectl get ns

kubectl create namespace instavote

kubectl get ns

</code></pre>

<p>And switch to it</p>
<pre><code>
kubectl config --help

kubectl config get-contexts

kubectl config current-context

kubectl config set-context --help

kubectl config set-context --current --namespace=instavote

kubectl config get-contexts

kubectl config view


</code></pre>

<p><strong>Exercise</strong>: Go back to the monitoring screen and observe what happens after switching the namespace.</p>
<p>To understand how ReplicaSets works with the selectors  lets launch a pod in the new namespace with existing specs.</p>
<pre><code>cd k8s-code/pods
kubectl apply -f vote-pod.yaml

kubectl get pods
</code></pre>

<h2 id="adding-replicaset-configurations">Adding ReplicaSet Configurations</h2>
<p>Lets now write the spec for the Rplica Set. This is going to mainly contain,</p>
<ul>
<li>replicas</li>
<li>selector</li>
<li>template (pod spec )</li>
<li>minReadySeconds</li>
</ul>
<p>From here on, we would switch to the project and environment specific path and work from there.</p>
<pre><code>cd projects/instavote/dev

</code></pre>

<p><code>edit file: vote-rs.yaml</code></p>
<pre><code>apiVersion: xxx
kind: xxx
metadata:
  xxx
spec:
  xxx
  template:
    metadata:
      name: vote
      labels:
        app: python
        role: vote
        version: v1
    spec:
      containers:
        - name: app
          image: schoolofdevops/vote:v1
          resources:
            requests:
              memory: &quot;64Mi&quot;
              cpu: &quot;50m&quot;
            limits:
              memory: &quot;128Mi&quot;
              cpu: &quot;250m&quot;
</code></pre>

<p>Above file already containts the spec that you had written for the pod. You would observe its already been added as part of <em>spec.template</em> for replicaset.</p>
<p>Lets now add the details specific to replicaset.</p>
<p><em>file: vote-rs.yaml</em></p>
<pre><code>apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: vote
spec:
  replicas: 4
  minReadySeconds: 20
  selector:
    matchLabels:
      role: vote
    matchExpressions:
      - {key: version, operator: In, values: [v1, v2, v3, v4, v5]}
  template:
    metadata:
      name: vote
      labels:
        app: python
        role: vote
        version: v1
    spec:
      containers:
        - name: app
          image: schoolofdevops/vote:v1
          resources:
            requests:
              memory: &quot;64Mi&quot;
              cpu: &quot;50m&quot;
            limits:
              memory: &quot;128Mi&quot;
              cpu: &quot;250m&quot;
</code></pre>

<p>The complete file will look similar to above. Lets now go ahead and apply it.</p>
<pre><code>kubectl apply -f vote-rs.yaml --dry-run

kubectl apply -f vote-rs.yaml

kubectl get rs

kubectl describe rs vote

kubectl get pods

kubectl get pods --show-labels
</code></pre>

<h3 id="high-availability">High Availability</h3>
<p>Try deleting pods created by the replicaset,</p>
<p><code>replace pod-xxxx and pod-yyyy with actuals</code></p>
<pre><code>kubectl get pods

kubectl delete pods vote-xxxx vote-yyyy
</code></pre>

<p>Observe as the pods are automatically created again.</p>
<p>Lets now delete the pod created independent of replica set.</p>
<pre><code>kubectl get pods
kubectl delete pods  vote
</code></pre>

<p>Observe what happens.
  * Does replica set take any action after deleting the pod created outside of its spec ? Why?</p>
<h3 id="exercise-deploying-new-version-of-the-application">Exercise: Deploying new version of the application</h3>
<pre><code>kubectl edit rs/vote
</code></pre>

<p>Update the version of the image from <strong>schoolofdevops/vote:v1</strong> to <strong>schoolofdevops/vote:v2</strong></p>
<p>Save the file.</p>
<p>Observe what happens ?</p>
<ul>
<li>Did application get  updated.</li>
<li>Did updating replicaset launched new pods to deploy new version ?</li>
</ul>
<h3 id="scalability">Scalability</h3>
<p>Scaling up application is as easy as running,  </p>
<pre><code>kubectl scale --replicas=8 rs/vote

kubectl get pods --show-labels
</code></pre>

<p>Observe what happens</p>
<ul>
<li>Did the number of  replicas increase to 8 ?</li>
<li>Which version of the app are the new pods running with ?</li>
</ul>
<h4 id="summary">Summary</h4>
<p>With <strong>ReplicaSets</strong> your application is now high available as well as scalable. However ReplicaSet by itself does not have the intelligence to trigger a rollout if you update the version. For that, you are going to need a <strong>deployment</strong> which is something you would learn in an upcoming  lesson.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../3_install_kubernetes/" class="btn btn-neutral float-right" title="Lab KD101 - Setup Kubernetes Cluster">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../5-vote-deploying_pods/" class="btn btn-neutral" title="Lab KP103 - Kubernetes LaunchPods"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../5-vote-deploying_pods/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../3_install_kubernetes/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
